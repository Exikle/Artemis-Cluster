---
clusterName: artemis-cluster
endpoint: https://artemis.dcunha.io:6443
talosVersion: v1.12.1
kubernetesVersion: 1.35.0

allowSchedulingOnControlPlanes: true

clusterPodNets:
  - 10.42.0.0/16
clusterSvcNets:
  - 10.43.0.0/16

cniConfig:
  name: none

patches:
  - "@machineconfig.yaml.j2"

nodes:
  - hostname: talos-cp-01
    ipAddress: 10.10.99.101
    controlPlane: true
    installDiskSelector:
      model: SAMSUNG MZVLW256HEHP-000L7
    machineSpec:
      secureboot: true
    # patches:
    #   - "@nodes/talos-cp-01.yaml.j2"
    schematic:
      customization:
        extraKernelArgs:
          - -lockdown
          - lockdown=integrity
        systemExtensions:
          officialExtensions:
            - siderolabs/intel-ucode
            - siderolabs/util-linux-tools
            - siderolabs/i915 # Intel iGPU
            - siderolabs/mei # Intel iGPU
            - siderolabs/nfsrahead

  - hostname: talos-cp-02
    ipAddress: 10.10.99.102
    controlPlane: true
    installDiskSelector:
      model: SAMSUNG MZVLW256HEHP-000L7
    machineSpec:
      secureboot: true
    # patches:
    #   - "@nodes/talos-cp-02.yaml.j2"
    schematic:
      customization:
        extraKernelArgs:
          - -lockdown
          - lockdown=integrity
        systemExtensions:
          officialExtensions:
            - siderolabs/intel-ucode
            - siderolabs/util-linux-tools
            - siderolabs/i915 # Intel iGPU
            - siderolabs/mei # Intel iGPU
            - siderolabs/nfsrahead

  - hostname: talos-cp-03
    ipAddress: 10.10.99.103
    controlPlane: true
    installDiskSelector:
      model: SAMSUNG MZVLW256HEHP-000L7
    machineSpec:
      secureboot: true
    # patches:
    #   - "@nodes/talos-cp-03.yaml.j2"
    schematic:
      customization:
        extraKernelArgs:
          - -lockdown
          - lockdown=integrity
        systemExtensions:
          officialExtensions:
            - siderolabs/intel-ucode
            - siderolabs/util-linux-tools
            - siderolabs/i915 # Intel iGPU
            - siderolabs/mei # Intel iGPU
            - siderolabs/nfsrahead

  - hostname: talos-w-01
    ipAddress: 10.10.99.201
    controlPlane: false
    installDisk: /dev/sda
    machineSpec:
      secureboot: true
    # patches:
    #   - "@nodes/talos-w-01.yaml.j2"
    schematic:
      customization:
        extraKernelArgs:
          - -lockdown
          - lockdown=integrity
        systemExtensions:
          officialExtensions:
            - siderolabs/qemu-guest-agent
            - siderolabs/util-linux-tools

  - hostname: talos-w-02
    ipAddress: 10.10.99.202
    controlPlane: false
    installDisk: /dev/sda
    machineSpec:
      secureboot: true
    # patches:
    #   - "@nodes/talos-w-02.yaml.j2"
    schematic:
      customization:
        extraKernelArgs:
          - -lockdown
          - lockdown=integrity
        systemExtensions:
          officialExtensions:
            - siderolabs/qemu-guest-agent
            - siderolabs/util-linux-tools

  - hostname: talos-w-03
    ipAddress: 10.10.99.203
    controlPlane: false
    installDisk: /dev/sda
    machineSpec:
      secureboot: true
    # patches:
    #   - "@nodes/talos-w-03.yaml.j2"
    schematic:
      customization:
        extraKernelArgs:
          - -lockdown
          - lockdown=integrity
        systemExtensions:
          officialExtensions:
            - siderolabs/qemu-guest-agent
            - siderolabs/util-linux-tools

controlPlane:
  patches:
    - |-
      machine:
        nodeLabels:
          bgppolicy: enabled
          node.kubernetes.io/exclude-from-external-load-balancers: ""
        features:
          kubernetesTalosAPIAccess:
            allowedKubernetesNamespaces:
              - actions-runner-system
              - system-upgrade
            allowedRoles:
            - os:admin
            enabled: true
    - |-
      cluster:
        allowSchedulingOnControlPlanes: true
        proxy:
          disabled: true
        coreDNS:
          disabled: true
        discovery:
          enabled: true
        apiServer:
          certSANs:
            - 127.0.0.1
            - 10.10.99.99
          extraArgs:
            feature-gates: MutatingAdmissionPolicy=true
            runtime-config: admissionregistration.k8s.io/v1beta1=true
            enable-aggregator-routing: "true"
        controllerManager:
          image: registry.k8s.io/kube-controller-manager:v1.35.0
          extraArgs:
            bind-address: 0.0.0.0
        etcd:
          advertisedSubnets:
            - 10.10.99.0/24
          extraArgs:
            listen-metrics-urls: http://0.0.0.0:2381

worker:
  patches:
    - |-
      cluster:
        proxy:
          disabled: true
        apiServer:
          certSANs:
            - 127.0.0.1
            - 10.10.99.99
            - artemis.dcunha.io
        scheduler:
          config:
            apiVersion: kubescheduler.config.k8s.io/v1
            kind: KubeSchedulerConfiguration
            profiles:
              - schedulerName: default-scheduler
                plugins:
                  score:
                    disabled:
                      - name: ImageLocality
                pluginConfig:
                  - name: PodTopologySpread
                    args:
                      defaultingType: List
                      defaultConstraints:
                        - maxSkew: 1
                          topologyKey: kubernetes.io/hostname
                          whenUnsatisfiable: ScheduleAnyway
