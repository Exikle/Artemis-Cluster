apiVersion: apps/v1
kind: Deployment
metadata:
 name: reaper
 namespace: default
 labels:
   app: reaper
spec:
 replicas: 1
 selector:
   matchLabels:
     app: reaper
 strategy:
   type: Recreate
 template:
   metadata:
     labels:
       app: reaper
   spec:
     containers:
     - image: target/pod-reaper:2.3.0
       name: pod-reaper-pod-status
       env:
         - name: POD_STATUSES
           value: Evicted
         - name: SCHEDULE
           value: "*/3 * * * *"
     - image: target/pod-reaper:2.3.0
       name: pod-reaper-container-status
       env:
         - name: CONTAINER_STATUSES
           value: "Completed,Error,ImagePullBackOff,ErrImagePull"
         - name: SCHEDULE
           value: "*/3 * * * *"
---
kind: ClusterRole
apiVersion: rbac.authorization.k8s.io/v1beta1
metadata:
  name: kube-stuck-pod-reaper-role
rules:
- apiGroups: [""]
  resources: ["pods"]
  verbs: ["get", "watch", "list"]
- apiGroups: [""]
  resources: ["pods/eviction"]
  verbs: ["create"]
---
kind: ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1beta1
metadata:
  name: read-pods-global
  namespace: kube-system
subjects:
- kind: User
  # TODO: change the role name to the one you need
  name: system:serviceaccount:default:default
  apiGroup: rbac.authorization.k8s.io
roleRef:
  kind: ClusterRole
  name: kube-stuck-pod-reaper-role
  apiGroup: rbac.authorization.k8s.io
