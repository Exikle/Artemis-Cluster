---
# yaml-language-server: $schema=https://raw.githubusercontent.com/bjw-s-labs/helm-charts/main/charts/other/app-template/schemas/helmrelease-helm-v2.schema.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: intel-device-plugin
spec:
  interval: 1h
  chartRef:
    kind: OCIRepository
    name: intel-device-plugin
  install:
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      strategy: rollback
      retries: 3
  values:
    nodeSelector:
      kubernetes.io/arch: amd64
      kubernetes.io/hostname: "talos-gpu-01"
    controllers:
      intel-device-plugin:
        type: daemonset
        containers:
          app:
            image:
              repository: intel/intel-gpu-plugin
              tag: 0.34.1
            env:
              NODE_NAME:
                valueFrom:
                  fieldRef:
                    fieldPath: spec.nodeName
              HOST_IP:
                valueFrom:
                  fieldRef:
                    fieldPath: status.hostIP
            args:
              - "-v"
              - "2"
              - "-shared-dev-num"
              - "5"
              - "-allocation-policy"
              - "none"
            securityContext:
              privileged: true
              readOnlyRootFilesystem: true
    persistence:
      dri:
        type: hostPath
        hostPath: /dev/dri
        globalMounts:
          - path: /dev/dri
      drm:
        type: hostPath
        hostPath: /sys/class/drm
        globalMounts:
          - path: /sys/class/drm
      devices:
        type: hostPath
        hostPath: /var/lib/kubelet/device-plugins
        globalMounts:
          - path: /var/lib/kubelet/device-plugins
      cdipath:
        type: hostPath
        hostPath: /var/cdi/dynamic # <--- CHANGED from /var/run/cdi
        globalMounts:
          - path: /var/run/cdi # The plugin internal path stays the same
