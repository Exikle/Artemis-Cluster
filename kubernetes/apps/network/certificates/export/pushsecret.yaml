# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/external-secrets.io/pushsecret_v1alpha1.json

# Push the source k8s Secret (tls.crt/tls.key) as a single JSON payload to Bitwarden Secrets Manager
apiVersion: external-secrets.io/v1alpha1
kind: PushSecret
metadata:
  name: dcunha-io-tls
spec:
  refreshInterval: 1h
  updatePolicy: Replace
  deletionPolicy: None
  secretStoreRefs:
    - name: bitwarden-clusterstore
      kind: ClusterSecretStore
  # Source secret inside the cluster
  selector:
    secret:
      name: dcunha-io-tls
  # Build the outbound payload as JSON, base64-encoding crt/key
  template:
    engineVersion: v2
    data:
      # The template key name here is arbitrary; we'll reference it in 'match.secretKey' below.
      cert: |
        {
          "crt": "{{ index . "tls.crt" | b64enc }}",
          "key": "{{ index . "tls.key" | b64enc }}"
        }
  data:
    - match:
        # This must match the key under spec.template.data (above)
        secretKey: cert
        remoteRef:
          # The destination Bitwarden Secret name/ID
          remoteKey: ${BW_DCUNHAIO_KEY}
          # For Bitwarden Secrets Manager, use 'value' as the target property
          property: value

# Found someones on github https://github.com/larivierec/home-cluster/blob/b41f314ca9a463a93d22173af9067892597cfa32/kubernetes/main/apps/cert-manager/cert-manager/issuers/push-cert.yaml#L3
# ---
# apiVersion: external-secrets.io/v1alpha1
# kind: PushSecret
# metadata:
#   name: prod-cert
#   namespace: cert-manager
# spec:
#   deletionPolicy: Delete
#   refreshInterval: 15m
#   secretStoreRefs:
#     - name: bitwarden-secrets-manager-sdk
#       kind: ClusterSecretStore
#   selector:
#     secret:
#       name: wildcard-cert-tls
#   template:
#     engineVersion: v2
#     data:
#       cert: |
#         {
#           "crt": "{{ index . "tls.crt" | b64enc }}",
#           "key": "{{ index . "tls.key" | b64enc }}"
#         }
#   data:
#     - match:
#         secretKey: cert
#         remoteRef:
#           remoteKey: garb_prod_cert
#           property: cert