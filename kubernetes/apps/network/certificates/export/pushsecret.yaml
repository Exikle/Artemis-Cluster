---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/external-secrets.io/pushsecret_v1alpha1.json
apiVersion: external-secrets.io/v1alpha1
kind: PushSecret
metadata:
  name: dcunha-io-tls
  namespace: network
spec:
  refreshInterval: 1h
  updatePolicy: Replace # Overwrite remote on each reconcile
  deletionPolicy: None # Keep remote if this resource is removed (set Delete if you prefer)

  secretStoreRefs:
    - name: bitwarden
      kind: ClusterSecretStore

  # Source: k8s Secret in the SAME namespace (PushSecret is namespaced)
  selector:
    secret:
      name: dcunha-io-tls

  # Build one JSON payload from the source secret
  template:
    engineVersion: v2
    data:
      payload: |-
        {
          "tls.crt": "{{ index . "tls.crt" | b64enc }}",
          "tls.key": "{{ index . "tls.key" | b64enc }}"
        }

  # Push the payload to Bitwarden Secrets Manager 'value' field
  data:
    - match:
        secretKey: payload
        remoteRef:
          remoteKey: dcunha-io-tls
          property: value
