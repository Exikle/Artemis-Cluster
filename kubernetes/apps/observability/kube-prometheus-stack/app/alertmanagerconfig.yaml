---
apiVersion: monitoring.coreos.com/v1alpha1
kind: AlertmanagerConfig
metadata:
  name: alertmanager
  labels:
    alertmanagerConfig: main
spec:
  route:
    groupBy: ["alertname", "job"]
    groupWait: 30s
    groupInterval: 5m
    repeatInterval: 12h
    receiver: "pushover"
    routes:
      - receiver: "heartbeat"
        matchers:
          - name: alertname
            value: Watchdog
            matchType: =
        groupWait: 0s
        groupInterval: 1m
        repeatInterval: 1m
      - receiver: "null"
        matchers:
          - name: alertname
            value: InfoInhibitor
            matchType: =
      - receiver: "pushover"
        matchers:
          - name: severity
            value: critical|warning
            matchType: =~
        continue: true

  inhibitRules:
    # FIXED: Changed from map to list of matchers
    - sourceMatch:
        - name: severity
          value: critical
      targetMatch:
        - name: severity
          value: warning
      equal: ["alertname", "namespace"]

  receivers:
    - name: "null"
    - name: "heartbeat"
      webhookConfigs:
        - urlSecret:
            name: alertmanager
            key: BUDDY_HEARTBEAT_URL
          sendResolved: true
          httpConfig:
            # FIXED: Removed 'authorization' block which is causing schema errors.
            # If you need auth, use basic auth or standard headers if your CRD supports it.
            # Assuming Token is part of the URL query param based on your ExternalSecret format.

    - name: "pushover"
      pushoverConfigs:
        # FIXED: Use 'token' and 'userKey' directly with valueFrom/secretKeyRef pattern
        # OR fallback to the older 'secret' definition if available.
        # Since 'userKeySecret' failed, we try the standard secret selector for the token.
        - token:
            name: alertmanager
            key: ALERTMANAGER_PUSHOVER_TOKEN
          userKey:
            name: alertmanager
            key: PUSHOVER_USER_KEY
          html: true
          message: |-
            {{- range .Alerts }}
              {{ .Annotations.summary }}
              <b>Description:</b> {{ .Annotations.description }}
              <b>Severity:</b> {{ .Labels.severity }}
            {{- end }}
          title: |-
            {{ .CommonLabels.alertname }} ({{ .Status }})
          url: "{{ .ExternalURL }}"
          priority: |-
            {{ if eq .Status "firing" }}{{ if eq .CommonLabels.severity "critical" }}2{{ else if eq .CommonLabels.severity "warning" }}1{{ else }}0{{ end }}{{ else }}0{{ end }}
          sound: |-
            {{ if eq .CommonLabels.severity "critical" }}siren{{ else }}gamelan{{ end }}
