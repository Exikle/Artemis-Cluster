---
apiVersion: v1
kind: Service
metadata:
  name: &app pve
  namespace: external-services
  annotations:
    gatus.home-operations.com/enabled: "true"
    gatus.home-operations.com/endpoint: |-
      url: "https://10.10.99.104:8006"
      group: external-infrastructure
      interval: 1m
      client:
        insecure: true
      conditions:
        - "[STATUS] == 200"
spec:
  ports:
    - name: https
      port: 8006
      protocol: TCP
      targetPort: 8006
  clusterIP: None
---
apiVersion: v1
kind: Endpoints
metadata:
  name: &app pve
  namespace: external-services
subsets:
  - addresses:
      - ip: 10.10.99.104
    ports:
      - port: 8006
        name: https
---
apiVersion: gateway.networking.k8s.io/v1alpha3
kind: BackendTLSPolicy
metadata:
  name: pve-backend-tls
  namespace: external-services
spec:
  targetRefs:
    - group: ""
      kind: Service
      name: pve
  validation:
    caCertificateRefs:
      - name: pve-ca-cert
        group: ""
        kind: ConfigMap
    hostname: pve.dcunha.lab
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: pve-ca-cert
  namespace: external-services
data:
  ca.crt: |
    -----BEGIN CERTIFICATE-----
    MIIFBzCCAu+gAwIBAgIBATANBgkqhkiG9w0BAQsFADB2MSQwIgYDVQQDDBtQcm94
    bW94IFZpcnR1YWwgRW52aXJvbm1lbnQxLTArBgNVBAsMJDA1Y2FlNDA5LTU3Yjkt
    NDlmNy1hZjk2LTZkZjNmMDAwN2Q2NzEfMB0GA1UECgwWUFZFIENsdXN0ZXIgTWFu
    YWdlciBDQTAeFw0yNDA1MTgwODIwNTRaFw0yNjA1MTgwODIwNTRaMF8xGTAXBgNV
    BAsTEFBWRSBDbHVzdGVyIE5vZGUxJDAiBgNVBAoTG1Byb3htb3ggVmlydHVhbCBF
    bnZpcm9ubWVudDEcMBoGA1UEAxMTcGFudGhlb24uZGN1bmhhLmxhYjCCASIwDQYJ
    KoZIhvcNAQEBBQADggEPADCCAQoCggEBAJBj3xlnVgLwAKcQNmW/wTeB8I4wuwB/
    qIcyIh8QJn6mvYq0fmDQk5zj7W/IDooudxmuceeoBo5joSB2rLVx48FysFaxL7EY
    vC35j9ton4wFjiT08PJzS3Jx5sFc3zdKHyo0pt4otAKc2W+deY3iGhNbzHpOtG6a
    valdAMgkAkAh2LTR8SIXBkmLI4yFqu+wfpSKA8zux9V/57V4uGiLux/JuNdol2eV
    PbdnoTurkH+FbHtBDzmcyNrHC7IWpCije75ttyLjDHLMsISIRAXkXCf0NzWwE2vr
    HiGKfbQIuFO5Q3mKZTt8XsWalEfpoMuwRkOBUWphTGolBzgrD5+1RdMCAwEAAaOB
    tjCBszAJBgNVHRMEAjAAMBMGA1UdJQQMMAoGCCsGAQUFBwMBMFEGA1UdEQRKMEiH
    BH8AAAGHEAAAAAAAAAAAAAAAAAAAAAGCCWxvY2FsaG9zdIcECgpjaIIIcGFudGhl
    b26CE3BhbnRoZW9uLmRjdW5oYS5sYWIwHQYDVR0OBBYEFCsEmmvZ8YaCRsrma4FI
    Od2WulFuMB8GA1UdIwQYMBaAFEk0C3clHCCK3AA0DFVWndnRurF5MA0GCSqGSIb3
    DQEBCwUAA4ICAQBJi4ORpa4YOGmlPyG7s1KP2ol7BYO3IkU1lltk8EPWiMuLm3o5
    QFMJAnkc73CmDNnkzr6UxZs9T78Ua9OKijdKG0dKNycJahCtdME/5otWdmySfLC8
    C0AxaBXg3WAT9yP3VNAhNlKJK4nniYZi1wO0m8annHAnniWePunBYSopitf+aijt
    eCmMc/vF0bUfaFxkVvuaF8VuZPozRdpFuxbcJsWU7JxkuA7GKdY507AEXBQcO660
    Ysm6ib1J658vrlyxe1IXHxcLsdYyRuvca35GbxXEdW/Vr9Csygn4RVKxzxeDKuE8
    yglMKiQZoBY/zxNtODBQVHA+0i375S2lWoSsuvF9UUK+EMQMnEXoL5E3bOX22X1U
    Imo1ArM0DMNJT5RpoejfL6DJm5IVw2HBzMVK0FHwVyVjJiSUrVmvFm6tBRIl1yKv
    D3b6n4MpBE8I0JcwZQf/oQH8Ivp5h7T8OgE34L3QIUHjhkJg32TGB7cHEIpvDrTB
    DKkRZ+/HB+oe0SAOb3U5+r8EaVqlxtCUX7dbWHzyQtMbiFNf29H5svKaH4o5WnL2
    U8upTBQjc4tY+5qeRuXUuT2qMV8MUqXBhdPj7QkXe8m2mFUQ0b31TdqKjRCn5yQC
    KZhT3k/RsyXYa3OPvxVZBN04Gph12QtKLfxF/6bEpJ1mS9Sflb6ADSb6fw==
    -----END CERTIFICATE-----
---
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: &app pve
  namespace: external-services
  annotations:
    external-dns.alpha.kubernetes.io/internal: "true"
    gatus.home-operations.com/enabled: "false"
spec:
  hostnames:
    - pve.dcunha.lab
  parentRefs:
    - name: internal-gateway
      namespace: default
      sectionName: https
  rules:
    - matches:
        - path:
            type: PathPrefix
            value: /
      backendRefs:
        - name: *app
          namespace: external-services
          port: 8006
      filters:
        - type: RequestHeaderModifier
          requestHeaderModifier:
            set:
              - name: X-Forwarded-Proto
                value: https
              - name: X-Forwarded-Host
                value: pve.dcunha.lab
              - name: X-Forwarded-Port
                value: "443"
