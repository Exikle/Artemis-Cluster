---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: truenas-nfs
  namespace: democratic-csi
spec:
  interval: 2m
  chart:
    spec:
      chart: democratic-csi
      version: 0.15.0
      sourceRef:
        kind: HelmRepository
        name: democratic-csi
        namespace: flux-system
      interval: 1m
  install:
    crds: CreateReplace
    remediation:
      retries: 3
  uninstall:
    keepHistory: false
  upgrade:
    cleanupOnFail: true
    crds: CreateReplace
    remediation:
      strategy: rollback
      retries: 3
  dependsOn:
    - name: snapshot-controller
      namespace: democratic-csi
  values:
    nameOverride: truenas-nfs
    csiDriver:
      name: org.democratic-csi.truenas-nfs

    controller:
      podAnnotations:
        secret.reloader.stakater.com/reload: truenas-nfs

      externalAttacher:
        enabled: false

      externalProvisioner:
        image: registry.k8s.io/sig-storage/csi-provisioner:v6.0.0
        args:
          - --v=5
          - --leader-election
          - --leader-election-namespace={{ .Release.Namespace }}
          - --timeout=180s
          - --worker-threads=10
          - --csi-address=/csi-data/csi.sock
        extraArgs:
          - --extra-create-metadata

      externalResizer:
        image: registry.k8s.io/sig-storage/csi-resizer:v2.0.0
        args:
          - --v=5
          - --leader-election
          - --leader-election-namespace={{ .Release.Namespace }}
          - --timeout=180s
          - --csi-address=/csi-data/csi.sock

      externalSnapshotter:
        enabled: true
        image: registry.k8s.io/sig-storage/csi-snapshotter:v8.4.0
        args:
          - --v=5
          - --leader-election
          - --leader-election-namespace={{ .Release.Namespace }}
          - --timeout=180s
          - --csi-address=/csi-data/csi.sock

      externalHealthMonitorController:
        enabled: false

      driver:
        logLevel: info
        image:
          repository: ghcr.io/democratic-csi/democratic-csi
          tag: v1.9.0
          pullPolicy: IfNotPresent

    node:
      driver:
        logLevel: info
        image:
          repository: ghcr.io/democratic-csi/democratic-csi
          tag: v1.9.0
          pullPolicy: IfNotPresent

      driverRegistrar:
        image:
          repository: registry.k8s.io/sig-storage/csi-node-driver-registrar
          tag: v2.15.0
          pullPolicy: IfNotPresent

        args:
          - --v=5
          - --csi-address=/csi-data/csi.sock
          - --kubelet-registration-path={{ .Values.node.kubeletHostPath }}/plugins/{{ .Values.csiDriver.name }}/csi.sock

    driver:
      config:
        driver: freenas-api-nfs
        httpConnection:
          protocol: https
          allowInsecure: true
        zfs:
          datasetParentName: atlas/media/k8s
          detachedSnapshotsDatasetParentName: atlas/media/k8s-snapshots
          datasetEnableQuotas: true
          datasetEnableReservation: false
          datasetPermissionsMode: "0777"
          datasetPermissionsUser: 0
          datasetPermissionsGroup: 0
          datasetProperties:
            "org.freenas:description": "{{ parameters.[csi.storage.k8s.io/pvc/namespace] }}/{{ parameters.[csi.storage.k8s.io/pvc/name] }}"
        nfs:
          shareStrategy: setPermissions
          shareStrategySetPermissionsMode: "0777"
          shareStrategySetPermissionsUser: 0
          shareStrategySetPermissionsGroup: 0
          shareHost: 10.10.99.100
          shareAlldirs: false
          shareAllowedHosts: []
          shareAllowedNetworks: []
          shareMaprootUser: root
          shareMaprootGroup: wheel

    storageClasses:
      - name: media-nfs
        defaultClass: false
        reclaimPolicy: Delete
        volumeBindingMode: Immediate
        allowVolumeExpansion: true
        parameters:
          fsType: nfs
          detachedVolumesFromSnapshots: false
          detachedVolumesFromVolumes: false
        mountOptions:
          - nfsvers=4.2
          - nconnect=8
          - hard
          - noatime
        secrets:
          provisioner-secret:
          controller-publish-secret:
          node-stage-secret:
          node-publish-secret:
          controller-expand-secret:

    volumeSnapshotClasses:
      - name: truenas-nfs-snapshot
        driver: org.democratic-csi.truenas-nfs
        annotations:
          snapshot.storage.kubernetes.io/is-default-class: "false"
        deletionPolicy: Delete
        parameters:
          detachedSnapshots: false

    csiProxy:
      image:
        repository: ghcr.io/democratic-csi/csi-grpc-proxy
        tag: v0.5.7
        pullPolicy: IfNotPresent

  valuesFrom:
    - targetPath: driver.config.httpConnection.host
      kind: Secret
      name: truenas-nfs
      valuesKey: TRUENAS_IP
    - targetPath: driver.config.httpConnection.port
      kind: Secret
      name: truenas-nfs
      valuesKey: TRUENAS_HTTPS_PORT
    - targetPath: driver.config.httpConnection.apiKey
      kind: Secret
      name: truenas-nfs
      valuesKey: TRUENAS_API_KEY
