{
  $schema: "https://docs.renovatebot.com/renovate-schema.json",
  description: "Renovate configuration for Artemis-Cluster",

  extends: [
    "config:best-practices",
    "docker:enableMajor",
    ":disableRateLimiting",
    ":dependencyDashboard",
    ":semanticCommits",
    ":automergeBranch",
  ],

  prConcurrentLimit: 10,
  branchConcurrentLimit: 5,
  prHourlyLimit: 2,
  prCreation: "not-pending",

  prBodyColumns: ["Package", "Type", "Update", "Change"],
  prBodyTemplate: "{{{header}}}{{{table}}}{{{notes}}}{{{changelogs}}}{{{footer}}}",
  commitBodyTable: true,
  commitMessagePrefix: "",
  commitMessageAction: "Update",

  dependencyDashboard: true,
  dependencyDashboardTitle: "Renovate Dashboard ðŸ¤–",
  dependencyDashboardHeader: "This dashboard shows all pending Renovate updates. Check boxes to approve/create PRs manually.",
  suppressNotifications: ["prEditedNotification", "prIgnoreNotification"],

  timezone: "America/Toronto",
  schedule: ["every weekday"],
  automergeSchedule: ["every weekday"],
  rebaseWhen: "conflicted",

  ignorePaths: ["**/*.sops.*", "**/*.secret.*"],

  vulnerabilityAlerts: {
    enabled: true,
    labels: ["security", "priority/high"],
    automerge: false,
  },

  flux: {
    fileMatch: ["(^|/)kubernetes/.+\\.ya?ml(?:\\.j2)?$"],
  },
  "helm-values": {
    fileMatch: [
      "(^|/)kubernetes/.+\\.ya?ml(?:\\.j2)?$",
      "(^|/).+values\\.ya?ml$",
      "(^|/)kubernetes/templates/.+\\.ya?ml$",
    ],
  },
  helmfile: {
    fileMatch: [
      "(^|/)helmfile\\.ya?ml(?:\\.j2)?$",
      "(^|/)kubernetes/templates/.+helmfile\\.ya?ml(?:\\.j2)?$",
    ],
  },
  kubernetes: {
    fileMatch: ["(^|/)kubernetes/.+\\.ya?ml(?:\\.j2)?$"],
  },
  kustomize: {
    fileMatch: ["(^|/)kustomization\\.ya?ml(?:\\.j2)?$"],
  },
  pip_requirements: {
    fileMatch: [
      "(^|/)[\\w-]*requirements(-\\w+)?\\.(txt|pip)(?:\\.j2)?$",
      "(^|/)kubernetes/.+requirements(-\\w+)?\\.(txt|pip)(?:\\.j2)?$",
    ],
  },
  dockerfile: {
    fileMatch: [
      "(^|/)Dockerfile$",
      "(^|/)Dockerfile\\.[^/]*$",
      "(^|/)kubernetes/.+/Dockerfile$",
    ],
  },

  packageRules: [
    {
      description: "Priority 1: Critical core components (Flux, Talos, Cilium)",
      matchPackagePatterns: ["^fluxcd", "^siderolabs", "^cilium"],
      priority: 10,
    },
    {
      description: "Priority 2: Platform infrastructure",
      matchPackagePatterns: [
        "^cert-manager",
        "^external-secrets",
        "^democratic-csi",
        "^rook",
        "gha-runner-scale-set",
      ],
      priority: 5,
    },
    {
      description: "Priority 3: Applications and everything else",
      matchPackagePatterns: [".*"],
      priority: 0,
    },
    {
      description: "Group all pin/digest updates to reduce PR spam",
      matchUpdateTypes: ["pin", "digest"],
      groupName: "dependency-pins",
      automerge: false,
      schedule: ["every weekend"],
      prCreation: "not-pending",
    },
    {
      description: "Auto-merge GitHub Actions patch updates after stability period",
      matchManagers: ["github-actions"],
      matchDatasources: ["github-tags"],
      matchUpdateTypes: ["patch"],
      automerge: true,
      automergeType: "branch",
      stabilityDays: 3,
    },
    {
      description: "Auto-merge container digest updates for trusted sources",
      matchDatasources: ["docker"],
      matchUpdateTypes: ["digest"],
      matchPackagePatterns: [
        "^ghcr.io/bjw-s",
        "^ghcr.io/onedr0p",
        "^ghcr.io/home-operations",
      ],
      automerge: true,
      automergeType: "branch",
    },
    {
      description: "Auto-merge patch container updates after stability period",
      matchDatasources: ["docker"],
      matchUpdateTypes: ["patch"],
      automerge: true,
      automergeType: "branch",
      stabilityDays: 2,
    },
    {
      description: "Auto-merge patch Helm chart updates after stability period",
      matchDatasources: ["helm"],
      matchUpdateTypes: ["patch"],
      automerge: true,
      automergeType: "branch",
      stabilityDays: 2,
    },
    {
      description: "Minor container/helm updates require dashboard approval",
      matchUpdateTypes: ["minor"],
      matchDatasources: ["docker", "helm"],
      dependencyDashboardApproval: true,
      automerge: false,
    },
    {
      description: "Major updates always require manual review",
      matchUpdateTypes: ["major"],
      dependencyDashboardApproval: true,
      automerge: false,
    },
    {
      description: "Group all Flux components",
      groupName: "Flux",
      matchPackagePatterns: ["^fluxcd"],
      matchDatasources: ["docker", "github-tags"],
      versioning: "semver",
      group: {
        commitMessageTopic: "{{{groupName}}} components",
      },
      separateMinorPatch: true,
    },
    {
      description: "Group all Talos components",
      groupName: "Talos",
      matchPackagePatterns: ["^siderolabs/talosctl", "^siderolabs/installer"],
      matchDatasources: ["docker"],
      group: {
        commitMessageTopic: "{{{groupName}}} components",
      },
      separateMinorPatch: true,
    },
    {
      description: "Group Actions Runner Controller",
      groupName: "Actions Runner Controller",
      matchPackagePatterns: ["gha-runner-scale-set"],
      matchDatasources: ["docker", "helm"],
      group: {
        commitMessageTopic: "{{{groupName}}} components",
      },
      separateMinorPatch: true,
    },
    {
      description: "Group Rook-Ceph components",
      groupName: "Rook-Ceph",
      matchPackagePatterns: ["^rook.ceph"],
      matchDatasources: ["helm"],
      group: {
        commitMessageTopic: "{{{groupName}}} components",
      },
      separateMinorPatch: true,
    },
    {
      description: "Group Dragonfly Operator",
      groupName: "Dragonfly Operator",
      matchPackagePatterns: ["^dragonfly(?:db)?.operator"],
      matchDatasources: ["docker", "github-releases"],
      group: {
        commitMessageTopic: "{{{groupName}}} components",
      },
      separateMinorPatch: true,
    },
    {
      description: "Group Intel Device Plugins",
      groupName: "Intel Device Plugins",
      matchPackagePatterns: ["^intel-device-plugins"],
      matchDatasources: ["helm"],
      group: {
        commitMessageTopic: "{{{groupName}}} components",
      },
      separateMinorPatch: true,
    },
    {
      description: "Group Cilium components",
      groupName: "Cilium",
      matchPackagePatterns: ["^cilium"],
      matchDatasources: ["docker", "helm"],
      group: {
        commitMessageTopic: "{{{groupName}}} components",
      },
      separateMinorPatch: true,
    },
    {
      description: "Group all GitHub Actions updates",
      groupName: "GitHub Actions",
      matchManagers: ["github-actions"],
      matchUpdateTypes: ["minor", "patch"],
      automerge: true,
      automergeType: "branch",
      stabilityDays: 3,
    },
    {
      description: "Label major updates",
      matchUpdateTypes: ["major"],
      labels: ["type/major", "priority/high"],
    },
    {
      description: "Label minor updates",
      matchUpdateTypes: ["minor"],
      labels: ["type/minor", "priority/medium"],
    },
    {
      description: "Label patch updates",
      matchUpdateTypes: ["patch"],
      labels: ["type/patch", "priority/low"],
    },
    {
      description: "Label digest updates",
      matchUpdateTypes: ["digest"],
      labels: ["type/digest"],
    },
    {
      description: "Label container updates",
      matchDatasources: ["docker"],
      addLabels: ["renovate/container"],
    },
    {
      description: "Label Helm updates",
      matchDatasources: ["helm"],
      addLabels: ["renovate/helm"],
    },
    {
      description: "Label GitHub Release updates",
      matchDatasources: ["github-releases", "github-tags"],
      addLabels: ["renovate/github-release"],
    },
    {
      description: "Label GitHub Actions updates",
      matchManagers: ["github-actions"],
      addLabels: ["renovate/github-action"],
    },
    {
      description: "Major container updates",
      matchDatasources: ["docker"],
      matchUpdateTypes: ["major"],
      commitMessagePrefix: "feat(container)!:",
      commitMessageTopic: "{{depName}}",
      commitMessageExtra: "({{currentVersion}} â†’ {{newVersion}})",
    },
    {
      description: "Minor container updates",
      matchDatasources: ["docker"],
      matchUpdateTypes: ["minor"],
      semanticCommitType: "feat",
      semanticCommitScope: "container",
      commitMessageTopic: "{{depName}}",
      commitMessageExtra: "({{currentVersion}} â†’ {{newVersion}})",
    },
    {
      description: "Patch container updates",
      matchDatasources: ["docker"],
      matchUpdateTypes: ["patch"],
      semanticCommitType: "fix",
      semanticCommitScope: "container",
      commitMessageTopic: "{{depName}}",
      commitMessageExtra: "({{currentVersion}} â†’ {{newVersion}})",
    },
    {
      description: "Container digest updates",
      matchDatasources: ["docker"],
      matchUpdateTypes: ["digest"],
      semanticCommitType: "chore",
      semanticCommitScope: "container",
      commitMessageTopic: "{{depName}}",
      commitMessageExtra: "({{currentDigestShort}} â†’ {{newDigestShort}})",
    },
    {
      description: "Major Helm updates",
      matchDatasources: ["helm"],
      matchUpdateTypes: ["major"],
      commitMessagePrefix: "feat(helm)!:",
      commitMessageTopic: "{{depName}}",
      commitMessageExtra: "({{currentVersion}} â†’ {{newVersion}})",
    },
    {
      description: "Minor Helm updates",
      matchDatasources: ["helm"],
      matchUpdateTypes: ["minor"],
      semanticCommitType: "feat",
      semanticCommitScope: "helm",
      commitMessageTopic: "{{depName}}",
      commitMessageExtra: "({{currentVersion}} â†’ {{newVersion}})",
    },
    {
      description: "Patch Helm updates",
      matchDatasources: ["helm"],
      matchUpdateTypes: ["patch"],
      semanticCommitType: "fix",
      semanticCommitScope: "helm",
      commitMessageTopic: "{{depName}}",
      commitMessageExtra: "({{currentVersion}} â†’ {{newVersion}})",
    },
    {
      description: "Major GitHub release updates",
      matchDatasources: ["github-releases", "github-tags"],
      matchUpdateTypes: ["major"],
      commitMessagePrefix: "feat(github-release)!:",
      commitMessageTopic: "{{depName}}",
      commitMessageExtra: "({{currentVersion}} â†’ {{newVersion}})",
    },
    {
      description: "Minor GitHub release updates",
      matchDatasources: ["github-releases", "github-tags"],
      matchUpdateTypes: ["minor"],
      semanticCommitType: "feat",
      semanticCommitScope: "github-release",
      commitMessageTopic: "{{depName}}",
      commitMessageExtra: "({{currentVersion}} â†’ {{newVersion}})",
    },
    {
      description: "Patch GitHub release updates",
      matchDatasources: ["github-releases", "github-tags"],
      matchUpdateTypes: ["patch"],
      semanticCommitType: "fix",
      semanticCommitScope: "github-release",
      commitMessageTopic: "{{depName}}",
      commitMessageExtra: "({{currentVersion}} â†’ {{newVersion}})",
    },
    {
      description: "Major GitHub Actions updates",
      matchManagers: ["github-actions"],
      matchUpdateTypes: ["major"],
      commitMessagePrefix: "feat(github-action)!:",
      commitMessageTopic: "{{depName}}",
      commitMessageExtra: "({{currentVersion}} â†’ {{newVersion}})",
    },
    {
      description: "Minor GitHub Actions updates",
      matchManagers: ["github-actions"],
      matchUpdateTypes: ["minor"],
      semanticCommitType: "feat",
      semanticCommitScope: "github-action",
      commitMessageTopic: "{{depName}}",
      commitMessageExtra: "({{currentVersion}} â†’ {{newVersion}})",
    },
    {
      description: "Patch GitHub Actions updates",
      matchManagers: ["github-actions"],
      matchUpdateTypes: ["patch"],
      semanticCommitType: "fix",
      semanticCommitScope: "github-action",
      commitMessageTopic: "{{depName}}",
      commitMessageExtra: "({{currentVersion}} â†’ {{newVersion}})",
    },
  ],

  customManagers: [
    {
      customType: "regex",
      description: "Match custom Renovate annotations in YAML files",
      fileMatch: ["(^|/)kubernetes/.+\\.ya?ml(?:\\.j2)?$"],
      matchStrings: [
        "# renovate: datasource=(?<datasource>\\S+) depName=(?<depName>\\S+)( repository=(?<registryUrl>\\S+))?\\n.+: (&\\S+\\s)?(?<currentValue>\\S+)",
      ],
      datasourceTemplate: "{{#if datasource}}{{{datasource}}}{{else}}github-releases{{/if}}",
    },
    {
      customType: "regex",
      description: "Match Grafana dashboard references",
      fileMatch: ["(^|/)kubernetes/.+\\.ya?ml(?:\\.j2)?$"],
      matchStrings: [
        '# renovate: depName="(?<depName>.*?)"\\n.*?url: https://grafana\\.com/api/dashboards/(?<packageName>\\d+)/revisions/(?<currentValue>\\d+)/download',
      ],
      datasourceTemplate: "grafana-dashboards",
      versioningTemplate: "regex:^(?<major>\\d+)$",
    },
    {
      customType: "regex",
      description: "Match Docker images in YAML comments",
      fileMatch: ["(^|/)kubernetes/.+\\.ya?ml(?:\\.j2)?$"],
      matchStrings: [
        "# renovate: container=(?<depName>.*?)\\n.*?(?<currentValue>[a-z0-9]+(?:[._-][a-z0-9]+)*)",
      ],
      datasourceTemplate: "docker",
    },
  ],
}
