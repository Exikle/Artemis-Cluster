{
  $schema: "https://docs.renovatebot.com/renovate-schema.json",
  description: "Renovate configuration for Artemis-Cluster",

  // ============================================================================
  // CORE CONFIGURATION
  // ============================================================================
  extends: [
    "config:best-practices", // âœ… Updated from config:recommended - includes latest security practices
    "docker:enableMajor", // Enable major Docker updates
    ":disableRateLimiting", // Disable rate limiting for self-hosted
    ":dependencyDashboard", // Enable dependency dashboard
    ":semanticCommits", // Use semantic commit messages
    ":automergeBranch", // Auto-merge to branch (not PR)
  ],

  // ============================================================================
  // RATE LIMITING & CONCURRENCY
  // ============================================================================
  prConcurrentLimit: 10, // âœ… NEW: Max 10 open PRs at once (prevents spam)
  prHourlyLimit: 2, // âœ… NEW: Max 2 PRs created per hour

  // ============================================================================
  // DASHBOARD SETTINGS
  // ============================================================================
  dependencyDashboard: true,
  dependencyDashboardTitle: "Renovate Dashboard ðŸ¤–",
  suppressNotifications: ["prEditedNotification", "prIgnoreNotification"],

  // ============================================================================
  // SCHEDULING
  // ============================================================================
  timezone: "America/Toronto",
  schedule: ["every weekday"], // Only run on weekdays
  automergeSchedule: ["every weekday"], // Only auto-merge on weekdays
  rebaseWhen: "conflicted", // Only rebase when conflicts exist

  // ============================================================================
  // SECURITY
  // ============================================================================
  ignorePaths: [
    "**/*.sops.*", // Ignore SOPS encrypted files
    "**/*.secret.*", // Ignore secret files
  ],

  // âœ… NEW: Security vulnerability handling
  vulnerabilityAlerts: {
    enabled: true,
    labels: ["security", "priority/high"],
    automerge: false, // Don't auto-merge security updates - require manual review
  },

  // ============================================================================
  // MANAGER CONFIGURATIONS
  // ============================================================================
  flux: {
    fileMatch: ["(^|/)kubernetes/.+\\.ya?ml(?:\\.j2)?$"],
  },
  "helm-values": {
    fileMatch: [
      "(^|/)kubernetes/.+\\.ya?ml(?:\\.j2)?$",
      "(^|/).+values\\.ya?ml$", // âœ… NEW: Catch root-level values files
      "(^|/)kubernetes/templates/.+\\.ya?ml$", // âœ… NEW: Catch template values
    ],
  },
  helmfile: {
    fileMatch: [
      "(^|/)helmfile\\.ya?ml(?:\\.j2)?$",
      "(^|/)kubernetes/templates/.+helmfile\\.ya?ml(?:\\.j2)?$", // âœ… NEW: Template helmfiles
    ],
  },
  kubernetes: {
    fileMatch: ["(^|/)kubernetes/.+\\.ya?ml(?:\\.j2)?$"],
  },
  kustomize: {
    fileMatch: ["(^|/)kustomization\\.ya?ml(?:\\.j2)?$"],
  },
  pip_requirements: {
    fileMatch: [
      "(^|/)[\\w-]*requirements(-\\w+)?\\.(txt|pip)(?:\\.j2)?$",
      "(^|/)kubernetes/.+requirements(-\\w+)?\\.(txt|pip)(?:\\.j2)?$", // âœ… NEW: Nested requirements
    ],
  },
  dockerfile: {
    // âœ… NEW: Docker file support
    fileMatch: [
      "(^|/)Dockerfile$",
      "(^|/)Dockerfile\\.[^/]*$",
      "(^|/)kubernetes/.+/Dockerfile$",
    ],
  },

  // ============================================================================
  // PACKAGE RULES
  // ============================================================================
  packageRules: [
    // --------------------------------------------------------------------------
    // AUTO-MERGE RULES (SECURITY FIXED - removed ignoreTests!)
    // --------------------------------------------------------------------------
    {
      description: "Auto-merge GitHub Actions patch updates after stability period",
      matchManagers: ["github-actions"],
      matchDatasources: ["github-tags"],
      matchUpdateTypes: ["patch"],
      automerge: true,
      automergeType: "branch",
      stabilityDays: 3, // âœ… NEW: Wait 3 days after release
      // âœ… FIXED: ignoreTests REMOVED - CI must pass before merge!
    },
    {
      description: "Auto-merge container digest updates for trusted sources",
      matchDatasources: ["docker"],
      matchUpdateTypes: ["digest"],
      matchPackagePatterns: ["^ghcr.io/bjw-s", "^ghcr.io/onedr0p"],
      automerge: true,
      automergeType: "branch",
      // âœ… FIXED: ignoreTests REMOVED - CI must pass!
    },
    {
      description: "Auto-merge patch container updates after stability period",
      matchDatasources: ["docker"],
      matchUpdateTypes: ["patch"],
      automerge: true,
      automergeType: "branch",
      stabilityDays: 2, // âœ… NEW: Wait 2 days for patch releases
      // âœ… FIXED: ignoreTests REMOVED - CI must pass!
    },
    {
      description: "Auto-merge patch Helm chart updates after stability period",
      matchDatasources: ["helm"],
      matchUpdateTypes: ["patch"],
      automerge: true,
      automergeType: "branch",
      stabilityDays: 2, // âœ… NEW: Wait 2 days for patch releases
      // âœ… FIXED: ignoreTests REMOVED - CI must pass!
    },

    // âœ… NEW: Minor updates require manual review for critical dependencies
    {
      description: "Minor container/helm updates require dashboard approval",
      matchUpdateTypes: ["minor"],
      matchDatasources: ["docker", "helm"],
      dependencyDashboardApproval: true, // Must be approved in Renovate dashboard
      automerge: false,
    },

    // --------------------------------------------------------------------------
    // GROUPED UPDATES
    // --------------------------------------------------------------------------
    {
      description: "Group all Flux components",
      groupName: "Flux",
      matchPackagePatterns: ["^fluxcd"],
      matchDatasources: ["docker", "github-tags"],
      versioning: "semver",
      group: {
        commitMessageTopic: "{{{groupName}}} components",
      },
      separateMinorPatch: true,
    },
    {
      description: "Group all Talos components",
      groupName: "Talos",
      matchPackagePatterns: ["^siderolabs/talosctl", "^siderolabs/installer"],
      matchDatasources: ["docker"],
      group: {
        commitMessageTopic: "{{{groupName}}} components",
      },
      separateMinorPatch: true,
    },
    {
      description: "Group Actions Runner Controller",
      groupName: "Actions Runner Controller",
      matchPackagePatterns: ["gha-runner-scale-set"],
      matchDatasources: ["docker", "helm"],
      group: {
        commitMessageTopic: "{{{groupName}}} components",
      },
      separateMinorPatch: true,
    },
    {
      description: "Group Rook-Ceph components",
      groupName: "Rook-Ceph",
      matchPackagePatterns: ["^rook.ceph"],
      matchDatasources: ["helm"],
      group: {
        commitMessageTopic: "{{{groupName}}} components",
      },
      separateMinorPatch: true,
    },
    {
      description: "Group Dragonfly Operator",
      groupName: "Dragonfly Operator",
      matchPackagePatterns: ["^dragonfly(?:db)?.operator"],
      matchDatasources: ["docker", "github-releases"],
      group: {
        commitMessageTopic: "{{{groupName}}} components",
      },
      separateMinorPatch: true,
    },
    {
      description: "Group Intel Device Plugins",
      groupName: "Intel Device Plugins",
      matchPackagePatterns: ["^intel-device-plugins"],
      matchDatasources: ["helm"],
      group: {
        commitMessageTopic: "{{{groupName}}} components",
      },
      separateMinorPatch: true,
    },
    {
      description: "Group Cilium components", // âœ… NEW: Group CNI updates
      groupName: "Cilium",
      matchPackagePatterns: ["^cilium"],
      matchDatasources: ["docker", "helm"],
      group: {
        commitMessageTopic: "{{{groupName}}} components",
      },
      separateMinorPatch: true,
    },

    // --------------------------------------------------------------------------
    // LABELS
    // --------------------------------------------------------------------------
    {
      description: "Label major updates",
      matchUpdateTypes: ["major"],
      labels: ["type/major", "priority/high"],
    },
    {
      description: "Label minor updates",
      matchUpdateTypes: ["minor"],
      labels: ["type/minor", "priority/medium"],
    },
    {
      description: "Label patch updates",
      matchUpdateTypes: ["patch"],
      labels: ["type/patch", "priority/low"],
    },
    {
      description: "Label digest updates",
      matchUpdateTypes: ["digest"],
      labels: ["type/digest"],
    },
    {
      description: "Label container updates",
      matchDatasources: ["docker"],
      addLabels: ["renovate/container"],
    },
    {
      description: "Label Helm updates",
      matchDatasources: ["helm"],
      addLabels: ["renovate/helm"],
    },
    {
      description: "Label GitHub Release updates",
      matchDatasources: ["github-releases", "github-tags"],
      addLabels: ["renovate/github-release"],
    },
    {
      description: "Label GitHub Actions updates",
      matchManagers: ["github-actions"],
      addLabels: ["renovate/github-action"],
    },

    // --------------------------------------------------------------------------
    // SEMANTIC COMMITS - CONTAINERS
    // --------------------------------------------------------------------------
    {
      description: "Major container updates",
      matchDatasources: ["docker"],
      matchUpdateTypes: ["major"],
      commitMessagePrefix: "feat(container)!:",
      commitMessageTopic: "{{depName}}",
      commitMessageExtra: "({{currentVersion}} â†’ {{newVersion}})",
    },
    {
      description: "Minor container updates",
      matchDatasources: ["docker"],
      matchUpdateTypes: ["minor"],
      semanticCommitType: "feat",
      semanticCommitScope: "container",
      commitMessageTopic: "{{depName}}",
      commitMessageExtra: "({{currentVersion}} â†’ {{newVersion}})",
    },
    {
      description: "Patch container updates",
      matchDatasources: ["docker"],
      matchUpdateTypes: ["patch"],
      semanticCommitType: "fix",
      semanticCommitScope: "container",
      commitMessageTopic: "{{depName}}",
      commitMessageExtra: "({{currentVersion}} â†’ {{newVersion}})",
    },
    {
      description: "Container digest updates",
      matchDatasources: ["docker"],
      matchUpdateTypes: ["digest"],
      semanticCommitType: "chore",
      semanticCommitScope: "container",
      commitMessageTopic: "{{depName}}",
      commitMessageExtra: "({{currentDigestShort}} â†’ {{newDigestShort}})",
    },

    // --------------------------------------------------------------------------
    // SEMANTIC COMMITS - HELM
    // --------------------------------------------------------------------------
    {
      description: "Major Helm updates",
      matchDatasources: ["helm"],
      matchUpdateTypes: ["major"],
      commitMessagePrefix: "feat(helm)!:",
      commitMessageTopic: "{{depName}}",
      commitMessageExtra: "({{currentVersion}} â†’ {{newVersion}})",
    },
    {
      description: "Minor Helm updates",
      matchDatasources: ["helm"],
      matchUpdateTypes: ["minor"],
      semanticCommitType: "feat",
      semanticCommitScope: "helm",
      commitMessageTopic: "{{depName}}",
      commitMessageExtra: "({{currentVersion}} â†’ {{newVersion}})",
    },
    {
      description: "Patch Helm updates",
      matchDatasources: ["helm"],
      matchUpdateTypes: ["patch"],
      semanticCommitType: "fix",
      semanticCommitScope: "helm",
      commitMessageTopic: "{{depName}}",
      commitMessageExtra: "({{currentVersion}} â†’ {{newVersion}})",
    },

    // --------------------------------------------------------------------------
    // SEMANTIC COMMITS - GITHUB RELEASES
    // --------------------------------------------------------------------------
    {
      description: "Major GitHub release updates",
      matchDatasources: ["github-releases", "github-tags"],
      matchUpdateTypes: ["major"],
      commitMessagePrefix: "feat(github-release)!:",
      commitMessageTopic: "{{depName}}",
      commitMessageExtra: "({{currentVersion}} â†’ {{newVersion}})",
    },
    {
      description: "Minor GitHub release updates",
      matchDatasources: ["github-releases", "github-tags"],
      matchUpdateTypes: ["minor"],
      semanticCommitType: "feat",
      semanticCommitScope: "github-release",
      commitMessageTopic: "{{depName}}",
      commitMessageExtra: "({{currentVersion}} â†’ {{newVersion}})",
    },
    {
      description: "Patch GitHub release updates",
      matchDatasources: ["github-releases", "github-tags"],
      matchUpdateTypes: ["patch"],
      semanticCommitType: "fix",
      semanticCommitScope: "github-release",
      commitMessageTopic: "{{depName}}",
      commitMessageExtra: "({{currentVersion}} â†’ {{newVersion}})",
    },

    // --------------------------------------------------------------------------
    // SEMANTIC COMMITS - GITHUB ACTIONS
    // --------------------------------------------------------------------------
    {
      description: "Major GitHub Actions updates",
      matchManagers: ["github-actions"],
      matchUpdateTypes: ["major"],
      commitMessagePrefix: "feat(github-action)!:",
      commitMessageTopic: "{{depName}}",
      commitMessageExtra: "({{currentVersion}} â†’ {{newVersion}})",
    },
    {
      description: "Minor GitHub Actions updates",
      matchManagers: ["github-actions"],
      matchUpdateTypes: ["minor"],
      semanticCommitType: "feat",
      semanticCommitScope: "github-action",
      commitMessageTopic: "{{depName}}",
      commitMessageExtra: "({{currentVersion}} â†’ {{newVersion}})",
    },
    {
      description: "Patch GitHub Actions updates",
      matchManagers: ["github-actions"],
      matchUpdateTypes: ["patch"],
      semanticCommitType: "fix",
      semanticCommitScope: "github-action",
      commitMessageTopic: "{{depName}}",
      commitMessageExtra: "({{currentVersion}} â†’ {{newVersion}})",
    },
  ],

  // ============================================================================
  // CUSTOM MANAGERS
  // ============================================================================
  customManagers: [
    {
      customType: "regex",
      description: "Match custom Renovate annotations in YAML files",
      fileMatch: ["(^|/)kubernetes/.+\\.ya?ml(?:\\.j2)?$"],
      matchStrings: [
        "# renovate: datasource=(?<datasource>\\S+) depName=(?<depName>\\S+)( repository=(?<registryUrl>\\S+))?\\n.+: (&\\S+\\s)?(?<currentValue>\\S+)",
      ],
      datasourceTemplate: "{{#if datasource}}{{{datasource}}}{{else}}github-releases{{/if}}",
    },
    {
      customType: "regex",
      description: "Match Grafana dashboard references",
      fileMatch: ["(^|/)kubernetes/.+\\.ya?ml(?:\\.j2)?$"],
      matchStrings: [
        '# renovate: depName="(?<depName>.*?)"\\n.*?url: https://grafana\\.com/api/dashboards/(?<packageName>\\d+)/revisions/(?<currentValue>\\d+)/download',
      ],
      datasourceTemplate: "grafana-dashboards",
      versioningTemplate: "regex:^(?<major>\\d+)$",
    },
    {
      customType: "regex", // âœ… NEW: Match Docker image references in comments
      description: "Match Docker images in YAML comments",
      fileMatch: ["(^|/)kubernetes/.+\\.ya?ml(?:\\.j2)?$"],
      matchStrings: [
        "# renovate: container=(?<depName>.*?)\\n.*?(?<currentValue>[a-z0-9]+(?:[._-][a-z0-9]+)*)",
      ],
      datasourceTemplate: "docker",
    },
  ],
}
