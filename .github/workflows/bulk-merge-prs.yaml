---
# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json
name: "Bulk Merge PRs"

on:
  workflow_dispatch:
    inputs:
      dryRun:
        description: Dry Run
        type: boolean
        default: true
        required: false
      labels:
        description: Labels (comma-separated, or 'any' for all)
        type: string
        default: "any"
        required: false
      deleteBranches:
        description: Delete branches after merge
        type: boolean
        default: true
        required: false

jobs:
  bulk-merge-prs:
    name: Bulk Merge PRs
    runs-on: ubuntu-latest
    steps:
      - name: Generate Token
        uses: actions/create-github-app-token@v2
        id: app-token
        with:
          app-id: "${{ secrets.BOT_APP_ID }}"
          private-key: "${{ secrets.BOT_APP_PRIVATE_KEY }}"

      - name: Checkout
        uses: actions/checkout@v5
        with:
          token: "${{ steps.app-token.outputs.token }}"

      - name: Bulk Merge PRs
        shell: bash
        env:
          GITHUB_TOKEN: "${{ steps.app-token.outputs.token }}"
          GH_REPO: ${{ github.repository }}
        run: |
          set -euo pipefail

          echo "üîç Searching for mergeable PRs..."

          # Build search query
          search_query="is:pr is:open -label:hold -label:type/major"

          # Add label filters if specified
          if [ "${{ github.event.inputs.labels }}" != "any" ]; then
            IFS=',' read -ra labels <<< "${{ github.event.inputs.labels }}"
            for label in "${labels[@]}"; do
              label=$(echo "${label}" | xargs)  # trim whitespace
              search_query="${search_query} label:${label}"
            done
          fi

          # Fetch PRs matching criteria
          echo "Search query: ${search_query}"
          prs=$(gh pr list \
            --search "${search_query}" \
            --json number,title,headRefName,statusCheckRollup \
            --jq '.[] | select(.statusCheckRollup // [] | all(.conclusion == "SUCCESS" or .conclusion == "NEUTRAL" or .conclusion == "SKIPPED")) | {number, title, headRefName}')

          if [ -z "${prs}" ]; then
            echo "‚úÖ No PRs found matching criteria with passing checks"
            exit 0
          fi

          # Count PRs
          pr_count=$(echo "${prs}" | jq -s 'length')
          echo "üìä Found ${pr_count} PR(s) ready to merge"

          # Process each PR
          echo "${prs}" | jq -c '.' | while read -r pr; do
            pr_number=$(echo "${pr}" | jq -r '.number')
            pr_title=$(echo "${pr}" | jq -r '.title')
            pr_branch=$(echo "${pr}" | jq -r '.headRefName')

            echo ""
            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
            echo "PR #${pr_number}: ${pr_title}"
            echo "Branch: ${pr_branch}"

            if [ "${{ github.event.inputs.dryRun }}" = "true" ]; then
              echo "üîç [DRY RUN] Would merge PR #${pr_number}"
              if [ "${{ github.event.inputs.deleteBranches }}" = "true" ]; then
                echo "üîç [DRY RUN] Would delete branch: ${pr_branch}"
              fi
            else
              echo "üîÑ Merging PR #${pr_number}..."

              merge_args=(--squash)

              if [ "${{ github.event.inputs.deleteBranches }}" = "true" ]; then
                merge_args+=(--delete-branch)
              fi

              if gh pr merge "${pr_number}" "${merge_args[@]}"; then
                echo "‚úÖ Successfully merged PR #${pr_number}"
              else
                echo "‚ùå Failed to merge PR #${pr_number}"
                # Continue with other PRs even if one fails
                continue
              fi
            fi
          done

          echo ""
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          if [ "${{ github.event.inputs.dryRun }}" = "true" ]; then
            echo "üîç Dry run complete. ${pr_count} PR(s) would be merged."
          else
            echo "‚úÖ Bulk merge complete. Processed ${pr_count} PR(s)."
          fi
