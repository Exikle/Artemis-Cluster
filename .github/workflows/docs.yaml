---
# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json
name: "Docs"

on:
  workflow_dispatch:
  push:
    branches: ["main"]
    paths:
      - .github/workflows/publish-docs.yaml
      - docs/**
      - README.md

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  # ============================================================================
  # Job 1: Build the documentation
  # ============================================================================
  build:
    name: Build Docs
    runs-on: ubuntu-latest

    steps:
      # Get repository code
      - name: Checkout
        uses: actions/checkout@v5

      # Configure GitHub Pages metadata
      # This step is required even in separate jobs to set up base URLs correctly
      - name: Setup Pages
        uses: actions/configure-pages@v5

      # Install mdBook documentation tool
      - name: Setup mdBook
        uses: peaceiris/actions-mdbook@v2
        with:
          mdbook-version: "0.4.44"

      # Build the documentation from Markdown to HTML
      - name: Build Documentation
        run: |
          cd docs              # Navigate to docs directory
          mdbook build         # Build the book (outputs to docs/book/)
        # If build fails (syntax errors, missing files, etc.), workflow stops here

      # Package the built site for GitHub Pages
      # This artifact persists between jobs so the deploy job can use it
      - name: Upload Pages Artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./docs/book
          # Artifact is stored temporarily and available to other jobs via 'needs'

  # ============================================================================
  # Job 2: Deploy the built documentation
  # ============================================================================
  deploy:
    name: Deploy Docs
    runs-on: ubuntu-latest

    # This job requires 'build' job to complete successfully first
    needs: build

    # GitHub Pages environment - shows deployment status in GitHub UI
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }} # Live site URL

    steps:
      # Deploy the artifact created in the 'build' job to GitHub Pages
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
        # This action:
        # 1. Automatically downloads the artifact from 'build' job
        # 2. Publishes to GitHub Pages (https://<username>.github.io/<repo>/)
        # 3. Updates deployment status in GitHub UI
        # 4. Returns page_url output for the environment URL
