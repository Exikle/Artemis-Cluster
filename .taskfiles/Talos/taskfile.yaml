---
# yaml-language-server: $schema=https://taskfile.dev/schema.json
version: "3"

vars: &vars
  CLUSTERNAME: artemis-cluster
  CONTROLPLANES:
    - talos-cp-01
    - talos-cp-02
    - talos-cp-03
  CONTROLPLANE_IPS:
    - 10.10.99.101
    - 10.10.99.102
    - 10.10.99.103
  TALOS_VIP: 10.10.99.99

tasks:

  bootstrap:
    desc: bootstrap Talos
    cmds:
      - task: bootstrap-talosctl
      - task: bootstrap-cluster
      - task: bootstrap-endpoints
      - task: bootstrap-startcluster
      - task: bootstrap-helm

  bootstrap-talosctl:
    desc: Install/Upgrade Talosctl
    cmd: brew install siderolabs/tap/talosctl

  # bootstrap-controlplane-config:
  #   desc: create config for talos control-planes

  bootstrap-cluster:
    desc: Bootstrap Cluster
    vars:
      INDEX: [0, 1, 2]
    cmds:
      - for: {var: INDEX}
        cmd: talosctl apply-config -f {{.TALOSCONFIG_DIR}}/assets/{{index .CONTROLPLANES .ITEM }}.yaml -n {{index .CONTROLPLANE_IPS .ITEM }} --insecure

  bootstrap-endpoints:
    desc: Apply endpoints to talosconfig
    cmd: talosctl --talosconfig=talosconfig config endpoint {{slice .CONTROLPLANE_IPS}}

  bootstrap-mergeconfig:
    desc: merge config into the default config stored at ~/.talos/config
    cmd: talosctl config merge talosconfig

  bootstrap-startcluster:
    desc: bootstrap Kubernetes
    cmd: talosctl bootstrap -n {{index .CONTROLPLANES 0 }}