version: "3"

tasks:
  bootstrap:
    desc: Full Flux Operator bootstrap pipeline
    cmds:
      - task: install-operator
      - task: apply-secrets
      - task: apply-instance
      - task: verify

  install-operator:
    desc: Install Flux Operator from GitHub
    cmds:
      - kubectl apply --server-side -f https://github.com/controlplaneio-fluxcd/flux-operator/releases/latest/download/install.yaml
      - echo "‚è≥ Waiting for Flux Operator..."
      - kubectl wait --for=condition=available --timeout=300s deployment/flux-operator -n flux-system
      - echo "‚úÖ Flux Operator ready"

  apply-secrets:
    desc: Decrypt and apply all SOPS secrets
    cmds:
      - echo "üîê Applying SOPS age secret..."
      - sops --decrypt {{.FLUX_SECRETS}}/age-key.secret.sops.yaml | kubectl apply --server-side -f -
      - echo "üîê Applying GitHub deploy key..."
      - sops --decrypt {{.FLUX_SECRETS}}/github.secret.sops.yaml | kubectl apply --server-side -f -
      - |
        if [ -f {{.FLUX_SECRETS}}/cluster-secrets.secret.sops.yaml ]; then
          echo "üîê Applying cluster secrets..."
          sops --decrypt {{.FLUX_SECRETS}}/cluster-secrets.secret.sops.yaml | kubectl apply --server-side -f -
        else
          echo "‚ÑπÔ∏è  No cluster-secrets found, skipping"
        fi
      - echo "‚úÖ All secrets applied"

  apply-instance:
    desc: Apply FluxInstance CR
    cmds:
      - echo "üì¶ Applying FluxInstance..."
      - kubectl apply --server-side -f {{.FLUX_BOOTSTRAP}}/flux-instance.yaml
      - echo "‚úÖ FluxInstance applied"

  verify:
    desc: Verify Flux installation
    cmds:
      - echo "üîç Checking FluxInstance..."
      - kubectl get fluxinstance -n flux-system
      - echo ""
      - echo "üîç Checking Flux deployments..."
      - kubectl get deployments -n flux-system
      - echo ""
      - echo "üîç Checking Flux pods..."
      - kubectl get pods -n flux-system
      - echo ""
      - echo "üîç Checking GitRepository..."
      - kubectl get gitrepository -n flux-system
      - echo ""
      - echo "üîç Checking Kustomizations..."
      - kubectl get kustomizations -n flux-system
      - echo ""
      - echo "üîç All Flux resources:"
      - flux get all -A

  reconcile:all:
    desc: Force reconcile all layers
    cmds:
      - flux reconcile source git flux-system
      - flux reconcile kustomization cluster-infrastructure
      - flux reconcile kustomization cluster-platform
      - flux reconcile kustomization cluster-apps

  reconcile:infra:
    desc: Force reconcile infrastructure layer
    cmds:
      - flux reconcile kustomization cluster-infrastructure -n flux-system

  reconcile:platform:
    desc: Force reconcile platform layer
    cmds:
      - flux reconcile kustomization cluster-platform -n flux-system

  reconcile:apps:
    desc: Force reconcile apps layer
    cmds:
      - flux reconcile kustomization cluster-apps -n flux-system
