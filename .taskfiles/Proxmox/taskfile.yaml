---
# yaml-language-server: $schema=https://taskfile.dev/schema.json
version: "3"

vars:
  CLOUDIMAGE_PATH: https://cloud-images.ubuntu.com/mantic/current/mantic-server-cloudimg-amd64.img

tasks:

  cloudinit:
    desc: Create CloudInit
    cmds:
      - ssh root@{{.PROXMOX_HOST}} -t "wget {{.CLOUDIMAGE_PATH}}"
      - ssh root@{{.PROXMOX_HOST}} -t "qm create 8000 --name 'ubuntu-cloudinit' --ostype l26 --memory 1024 --agent 1 --bios ovmf --machine q35 --efidisk0 local-lvm:0,pre-enrolled-keys=0 --cpu host --socket 1 --cores 1 --vga serial0 --serial0 socket --net0 virtio,bridge=vmbr0"
      - ssh root@{{.PROXMOX_HOST}} -t "qm importdisk 8000 mantic-server-cloudimg-amd64.img local-lvm"
      - ssh root@{{.PROXMOX_HOST}} -t "qm set 8000 --scsihw virtio-scsi-pci --virtio0 local-lvm:vm-8000-disk-1,discard=on"
      - ssh root@{{.PROXMOX_HOST}} -t "qm set 8000 --boot order=virtio0"
      - ssh root@{{.PROXMOX_HOST}} -t "qm set 8000 --ide2 local-lvm:cloudinit"
      - ssh root@{{.PROXMOX_HOST}} -t "qm set 8000 --cicustom "vendor=local:snippets/vendor.yaml""
      - ssh root@{{.PROXMOX_HOST}} -t "qm set 8000 --tags template,23.10,cloudinit,ubuntu"
      - ssh root@{{.PROXMOX_HOST}} -t "qm set 8000 --ciuser root"
      - ssh root@{{.PROXMOX_HOST}} -t "qm set 8000 --cipassword $(openssl passwd -6 $CLEARTEXT_PASSWORD)"
      # - ssh root@{{.PROXMOX_HOST}} -t "qm set 8000 --sshkeys ~/.ssh/authorized_keys"
      - ssh root@{{.PROXMOX_HOST}} -t "qm set 8000 --ipconfig0 ip=dhcp"

  listfiles:
    cmd: ssh root@{{.PROXMOX_HOST}} -t 'ls -l'
