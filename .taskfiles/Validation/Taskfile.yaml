version: "3"

tasks:
  secrets:
    desc: Test SOPS secret decryption for all secrets
    cmds:
      - echo "üîç Testing SOPS secrets..."
      - for f in {{.FLUX_SECRETS}}/*.sops.yaml; do echo "Testing $f"; sops --decrypt "$f" > /dev/null && echo "‚úÖ $f" || echo "‚ùå $f"; done

  kustomize:
    desc: Validate all kustomize builds
    cmds:
      - echo "üîç Building infrastructure..."
      - kustomize build {{.CLUSTER_DIR}}/infrastructure > /dev/null && echo "‚úÖ infrastructure"
      - echo "üîç Building platform..."
      - kustomize build {{.CLUSTER_DIR}}/platform > /dev/null && echo "‚úÖ platform"
      - echo "üîç Building apps..."
      - kustomize build {{.CLUSTER_DIR}}/apps > /dev/null && echo "‚úÖ apps"
      - echo "üîç Building flux config..."
      - kustomize build {{.CLUSTER_DIR}}/flux/config > /dev/null && echo "‚úÖ flux/config"

  yaml:
    desc: Lint all YAML files
    cmds:
      - find {{.CLUSTER_DIR}} -name '*.yaml' -type f | xargs yamllint -d relaxed

  all:
    desc: Run all validation checks
    cmds:
      - task: secrets
      - task: kustomize
      - task: yaml

  sops:encrypt:
    desc: Encrypt a file with SOPS (usage - task validate:sops:encrypt INPUT=file.yaml OUTPUT=file.sops.yaml)
    vars:
      AGE_PUBLIC_KEY:
        sh: grep "public key:" ~/.sops/age.agekey | awk '{print $NF}'
    cmds:
      - |
        if [ -z "{{.INPUT}}" ]; then
          echo "‚ùå Error: INPUT parameter required"
          echo "Usage: task validate:sops:encrypt INPUT=file.yaml OUTPUT=file.sops.yaml"
          exit 1
        fi
      - |
        if [ -z "{{.OUTPUT}}" ]; then
          echo "‚ùå Error: OUTPUT parameter required"
          echo "Usage: task validate:sops:encrypt INPUT=file.yaml OUTPUT=file.sops.yaml"
          exit 1
        fi
      - |
        if [ ! -f "{{.INPUT}}" ]; then
          echo "‚ùå Error: Input file '{{.INPUT}}' not found"
          exit 1
        fi
      - echo "üîê Encrypting {{.INPUT}} -> {{.OUTPUT}}"
      - echo "Using age key: {{.AGE_PUBLIC_KEY}}"
      - sops --encrypt --age "{{.AGE_PUBLIC_KEY}}" --encrypted-regex '^(data|stringData)$' "{{.INPUT}}" > "{{.OUTPUT}}"
      - echo "‚úÖ Encrypted: {{.OUTPUT}}"

  sops:decrypt:
    desc: Decrypt a SOPS file (usage - task validate:sops:decrypt INPUT=file.sops.yaml OUTPUT=file.yaml)
    cmds:
      - |
        if [ -z "{{.INPUT}}" ]; then
          echo "‚ùå Error: INPUT parameter required"
          echo "Usage: task validate:sops:decrypt INPUT=file.sops.yaml OUTPUT=file.yaml"
          exit 1
        fi
      - |
        if [ -z "{{.OUTPUT}}" ]; then
          echo "‚ùå Error: OUTPUT parameter required"
          echo "Usage: task validate:sops:decrypt INPUT=file.sops.yaml OUTPUT=file.yaml"
          exit 1
        fi
      - |
        if [ ! -f "{{.INPUT}}" ]; then
          echo "‚ùå Error: Input file '{{.INPUT}}' not found"
          exit 1
        fi
      - echo "üîì Decrypting {{.INPUT}} -> {{.OUTPUT}}"
      - sops --decrypt "{{.INPUT}}" > "{{.OUTPUT}}"
      - echo "‚úÖ Decrypted: {{.OUTPUT}}"
      - echo "‚ö†Ô∏è  WARNING: Plaintext file created! Delete after use or add to .gitignore"

  sops:view:
    desc: View decrypted content without saving (usage - task validate:sops:view FILE=file.sops.yaml)
    cmds:
      - |
        if [ -z "{{.FILE}}" ]; then
          echo "‚ùå Error: FILE parameter required"
          echo "Usage: task validate:sops:view FILE=file.sops.yaml"
          exit 1
        fi
      - |
        if [ ! -f "{{.FILE}}" ]; then
          echo "‚ùå Error: File '{{.FILE}}' not found"
          exit 1
        fi
      - sops --decrypt "{{.FILE}}"

  sops:edit:
    desc: Edit a SOPS encrypted file in-place (usage - task validate:sops:edit FILE=file.sops.yaml)
    cmds:
      - |
        if [ -z "{{.FILE}}" ]; then
          echo "‚ùå Error: FILE parameter required"
          echo "Usage: task validate:sops:edit FILE=file.sops.yaml"
          exit 1
        fi
      - |
        if [ ! -f "{{.FILE}}" ]; then
          echo "‚ùå Error: File '{{.FILE}}' not found"
          exit 1
        fi
      - echo "‚úèÔ∏è  Editing {{.FILE}}..."
      - sops "{{.FILE}}"

  sops:rotate:
    desc: Rotate SOPS keys in an encrypted file (usage - task validate:sops:rotate FILE=file.sops.yaml)
    vars:
      AGE_PUBLIC_KEY:
        sh: grep "public key:" ~/.sops/age.agekey | awk '{print $NF}'
    cmds:
      - |
        if [ -z "{{.FILE}}" ]; then
          echo "‚ùå Error: FILE parameter required"
          echo "Usage: task validate:sops:rotate FILE=file.sops.yaml"
          exit 1
        fi
      - |
        if [ ! -f "{{.FILE}}" ]; then
          echo "‚ùå Error: File '{{.FILE}}' not found"
          exit 1
        fi
      - echo "üîÑ Rotating keys for {{.FILE}}"
      - echo "Using age key: {{.AGE_PUBLIC_KEY}}"
      - sops --rotate --age "{{.AGE_PUBLIC_KEY}}" --in-place "{{.FILE}}"
      - echo "‚úÖ Keys rotated"
